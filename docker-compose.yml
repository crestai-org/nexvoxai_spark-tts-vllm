version: '3.8'

services:
  spark-tts:
    build: .
    container_name: spark-tts-streaming
    ports:
      - "8000:8000"
    environment:
      - CUDA_VISIBLE_DEVICES=0,1
      - MODEL_NAME=crestai/spark-tts-nexvox-v2
      - TOKENIZER_REPO=unsloth/Spark-TTS-0.5B
      - TOKENIZER_CACHE_DIR=Spark-TTS-0.5B
      - SPARK_TTS_REPO_PATH=Spark-TTS
      - HF_TOKEN=
      - NCCL_DEBUG=WARN
      - NCCL_SOCKET_IFNAME=lo
      - NCCL_IB_DISABLE=1
      - NCCL_P2P_DISABLE=1
      - NCCL_NET_GDR_LEVEL=0
      - NCCL_SHM_DISABLE=1
      - NCCL_TREE_THRESHOLD=0
      - NCCL_RING_THRESHOLD=8388608
    volumes:
      - ./cache:/app/cache
      - ./Spark-TTS-0.5B:/app/Spark-TTS-0.5B
    shm_size: '2gb'
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']     # Explicitly name the GPUs (matches CUDA_VISIBLE_DEVICES)
              capabilities: [gpu]
    # Optional: Add this line if you want to force legacy runtime (but try without first)
    # runtime: nvidia
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s